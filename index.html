<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ìœµí•© ë¯¸ë””ì–´ì•„íŠ¸ ì—°êµ¬ì†Œ</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        /* í°íŠ¸ & ê¸°ë³¸ ì„¤ì • */
        body { font-family: 'Pretendard', 'Malgun Gothic', sans-serif; margin: 0; overflow: hidden; display: flex; height: 100vh; background-color: #f1f3f5; }
        
        /* ë¡œê·¸ì¸ ì˜¤ë²„ë ˆì´ */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .login-box { background: white; padding: 40px; border-radius: 16px; text-align: center; width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .login-box input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 12px; background: #4c6ef5; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 10px; }

        /* === [ë©”ì¸ ë ˆì´ì•„ì›ƒ] === */
        #main-app { display: none; width: 100%; height: 100%; }

        /* 1. ì™¼ìª½ íŒ¨ë„ (ì½”ë“œ + í•˜ë‹¨ ì‹¤í–‰ì˜ì—­) : í™”ë©´ì˜ 50% ì°¨ì§€ (ìˆ˜ì •ë¨) */
        #left-panel { 
            width: 50%; 
            display: flex; 
            flex-direction: column; 
            border-right: 1px solid #ced4da; 
            background: white; 
            padding: 15px; 
            box-sizing: border-box;
        }

        /* ì½”ë“œ ì—ë””í„° ì˜ì—­ (ìƒë‹¨) */
        .editor-section { flex: 1; display: flex; flex-direction: column; overflow: hidden; margin-bottom: 10px; }
        h3 { margin: 5px 0 5px 0; font-size: 15px; color: #495057; display: flex; align-items: center; gap: 5px; }
        textarea { width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 6px; resize: none; font-family: 'D2Coding', monospace; outline: none; box-sizing: border-box; }
        #teacher-code { height: 80px; background-color: #f8f9fa; color: #495057; margin-bottom: 10px; }
        #student-code { flex: 1; background-color: #fff; color: #212529; border: 2px solid #e9ecef; }
        #student-code:focus { border-color: #4c6ef5; }

        /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ ì˜ì—­ (ë²„íŠ¼ 1/3 + ìº”ë²„ìŠ¤ 2/3) */
        .bottom-control-area { 
            height: 250px; /* ë†’ì´ ê³ ì • */
            display: flex; 
            gap: 10px; 
            border-top: 1px solid #e9ecef; 
            padding-top: 15px; 
        }

        /* ì™¼ìª½: ë²„íŠ¼ ê·¸ë£¹ (1/3) */
        .btn-group { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
        }
        .btn-group button { 
            flex: 1; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 14px; 
            transition: 0.2s; 
        }
        #run-btn { background-color: #4c6ef5; color: white; }
        #run-btn:hover { background-color: #364fc7; }
        #save-btn { background-color: #20c997; color: white; }
        #save-btn:hover { background-color: #12b886; }

        /* ì˜¤ë¥¸ìª½: ìº”ë²„ìŠ¤ (2/3) */
        #canvas-wrapper {
            flex: 2; 
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        #canvas-frame { width: 100%; height: 100%; border: none; }


        /* 2. ì˜¤ë¥¸ìª½ íŒ¨ë„ (AI ì±„íŒ…) : í™”ë©´ì˜ 50% ì°¨ì§€ (ìˆ˜ì •ë¨) */
        #right-panel { 
            width: 50%; 
            display: flex; 
            flex-direction: column; 
            background: #f8f9fa; 
            border-left: 1px solid #fff;
            height: 100%; /* ë†’ì´ ê½‰ ì±„ìš°ê¸° */
            overflow: hidden; /* ì „ì²´ ìŠ¤í¬ë¡¤ ë°©ì§€ */
        }

        /* ì±„íŒ…ì°½ ë ˆì´ì•„ì›ƒ ìˆ˜ì • (ì…ë ¥ì°½ ê³ ì •ìš©) */
        #chat-container { 
            flex: 1; /* ë‚¨ì€ ê³µê°„ ëª¨ë‘ ì°¨ì§€ */
            display: flex; 
            flex-direction: column; 
            padding: 15px; 
            padding-bottom: 0;
            overflow: hidden; /* ë‚´ë¶€ ìŠ¤í¬ë¡¤ ì œì–´ */
        }
        
        #chat-header { 
            font-size: 18px; 
            font-weight: bold; 
            color: #343a40; 
            margin-bottom: 15px; 
            flex-shrink: 0; /* í—¤ë” í¬ê¸° ê³ ì • */
        }

        /* ì—¬ê¸°ê°€ ìŠ¤í¬ë¡¤ë˜ëŠ” ì˜ì—­ */
        #chat-area { 
            flex: 1; 
            overflow-y: auto; 
            padding-right: 5px; 
            margin-bottom: 10px; 
            /* ìŠ¤í¬ë¡¤ ë¶€ë“œëŸ½ê²Œ */
            scroll-behavior: smooth;
        }
        
        /* ì…ë ¥ì°½ ì˜ì—­ (í•­ìƒ í•˜ë‹¨ ê³ ì •) */
        #input-area { 
            flex-shrink: 0; /* í¬ê¸° ì¤„ì–´ë“¤ì§€ ì•ŠìŒ */
            background: white; 
            padding: 15px; 
            border-top: 1px solid #dee2e6; 
            display: flex; 
            gap: 10px; 
        }
        
        #user-input { flex: 1; padding: 12px; border: 1px solid #ced4da; border-radius: 25px; outline: none; font-size: 14px; }
        #user-input:focus { border-color: #4c6ef5; }
        #send-btn { padding: 0 20px; background: #4c6ef5; color: white; border: none; border-radius: 25px; font-weight: bold; cursor: pointer; white-space: nowrap; }

        /* ë§í’ì„  ìŠ¤íƒ€ì¼ */
        .msg-ai { text-align: left; margin: 8px 0; }
        .msg-ai span { background-color: #e9ecef; padding: 10px 14px; border-radius: 0 18px 18px 18px; display: inline-block; color: #333; font-size: 14px; line-height: 1.5; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .msg-user { text-align: right; margin: 8px 0; }
        .msg-user span { background-color: #4c6ef5; color: white; padding: 10px 14px; border-radius: 18px 0 18px 18px; display: inline-block; font-size: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .error-msg { color: #fa5252; font-size: 0.85em; text-align: center; margin: 10px 0; }

        /* ìŠ¤í¬ë¡¤ë°” ê¾¸ë¯¸ê¸° */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #ced4da; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2>ğŸ¨ ArtLab ì…ì¥</h2>
            <input type="text" id="input-school-id" placeholder="í•™ë²ˆ (ì˜ˆ: 10101)">
            <input type="text" id="input-name" placeholder="ì´ë¦„ (ì˜ˆ: ê¹€ë¯¸ë˜)">
            <button onclick="handleLogin()">ì…ì¥í•˜ê¸°</button>
        </div>
    </div>

    <div id="main-app">
        
        <div id="left-panel">
            <div class="editor-section">
                <div style="display: flex; justify-content: space-between;">
                    <h3>ğŸ”’ ê¸°ë³¸ ì„¤ì •</h3>
                    <span id="display-user" style="font-size: 13px; color: #868e96; font-weight: bold;"></span>
                </div>
                <textarea id="teacher-code" readonly>
let distance = 0;
function setup() {
  createCanvas(windowWidth, windowHeight);
  background(240);
}</textarea>

                <h3>âœ¨ ë‚˜ì˜ ì½”ë“œ</h3>
                <textarea id="student-code">
function draw() {
  distance = mouseX; 
  background(240); 
  fill(255, 100, 150);
  circle(width/2, height/2, distance);
}</textarea>
            </div>

            <div class="bottom-control-area">
                <div class="btn-group">
                    <button id="run-btn" onclick="runCode()">â–¶ ì½”ë“œ ì‹¤í–‰</button>
                    <button id="save-btn" onclick="saveCode()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
                </div>
                <div id="canvas-wrapper">
                    <iframe id="canvas-frame"></iframe>
                </div>
            </div>
        </div>

        <div id="right-panel">
            <div id="chat-container">
                <div id="chat-header">ğŸ¤– AI ë©˜í† </div>
                <div id="chat-area">
                    <div class="msg-ai"><span>ë°˜ê°€ì›Œìš”! ì˜¤ëŠ˜ì€ ì–´ë–¤ ì½”ë“œë¥¼ ë§Œë“¤ì–´ë³¼ê¹Œìš”? ë§‰íˆëŠ” ë¶€ë¶„ì´ ìˆìœ¼ë©´ ì–¸ì œë“  ë¬¼ì–´ë³´ì„¸ìš”. ğŸ˜Š</span></div>
                </div>
            </div>
            <div id="input-area">
                <input type="text" id="user-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...">
                <button id="send-btn" onclick="sendMessage()">ì „ì†¡</button>
            </div>
        </div>

    </div>

    <script>
        // ==========================================
        // ê¸°ë³¸ ë¡œì§
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDqu_8E4nqi8Q7GvPiBGlaM7rng2px_8HM",
            authDomain: "artlab-c0e83.firebaseapp.com",
            projectId: "artlab-c0e83",
            storageBucket: "artlab-c0e83.firebasestorage.app",
            messagingSenderId: "612718659232",
            appId: "1:612718659232:web:94cc0d785731bddceaabc5",
            measurementId: "G-FY3YR269E0"
        };

        let auth, db;
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
        } catch (e) { console.error(e); }

        function handleLogin() {
            const sid = document.getElementById('input-school-id').value;
            const sname = document.getElementById('input-name').value;
            if (!sid || !sname) { alert("ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; }

            auth.signInAnonymously().then((cred) => {
                db.collection("students").doc(sid).set({
                    uid: cred.user.uid, schoolId: sid, name: sname, lastLogin: new Date()
                }, { merge: true }).then(() => {
                    document.getElementById('login-overlay').style.display = 'none';
                    document.getElementById('main-app').style.display = 'flex';
                    document.getElementById('display-user').innerText = `${sid} ${sname}`;
                    runCode(); 
                });
            }).catch((e) => alert("ë¡œê·¸ì¸ ì˜¤ë¥˜: " + e.message));
        }

        function saveCode() {
            const sid = document.getElementById('input-school-id').value;
            const code = document.getElementById('student-code').value;
            const btn = document.getElementById('save-btn');
            
            btn.innerText = "â³ ì €ì¥ ì¤‘...";
            db.collection("students").doc(sid).set({ code: code, savedAt: new Date() }, { merge: true })
            .then(() => { alert("ì €ì¥ ì™„ë£Œ!"); btn.innerText = "ğŸ’¾ ì €ì¥í•˜ê¸°"; })
            .catch((e) => { alert("ì‹¤íŒ¨: " + e.message); btn.innerText = "ğŸ’¾ ì €ì¥í•˜ê¸°"; });
        }

        function runCode() {
            const fullCode = document.getElementById('teacher-code').value + "\n" + document.getElementById('student-code').value;
            const html = `<html><head><script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.js"><\/script></head><body style="margin:0;"><script>try{${fullCode}}catch(e){console.error(e)}<\/script></body></html>`;
            document.getElementById('canvas-frame').srcdoc = html;
        }

        async function sendMessage() {
            // âœ… ì„ ìƒë‹˜ì˜ API í‚¤
            const GOOGLE_API_KEY = "AIzaSyDmkBfu4WkgE4WOvlrS8lOb-4F-zm9ppKM"; 
            
            // âœ… ìš”ì²­í•˜ì‹  ëª¨ë¸ëª…
            const MODEL_NAME = "gemini-3-flash-preview"; 
            
            const inputField = document.getElementById('user-input');
            const chatArea = document.getElementById('chat-area');
            const userText = inputField.value;
            const studentCode = document.getElementById('student-code').value;
            
            // ì €ì¥ìš© ì •ë³´
            const sid = document.getElementById('input-school-id').value;
            const sname = document.getElementById('input-name').value;

            if (userText.trim() === "") return; 

            chatArea.innerHTML += `<div class="msg-user"><span>${userText}</span></div>`;
            inputField.value = ""; 
            
            // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ (requestAnimationFrameìœ¼ë¡œ ë Œë”ë§ í›„ ì‹¤í–‰ ë³´ì¥)
            requestAnimationFrame(() => {
                chatArea.scrollTop = chatArea.scrollHeight;
            });

            // âœ… ìš”ì²­í•˜ì‹  ê³ ë“±í•™êµ ì„ ìƒë‹˜ ë©˜íŠ¸
            const prompt = `
                ë‹¹ì‹ ì€ ê³ ë“±í•™êµ ì„ ìƒë‹˜ì´ì ì‹¤ë ¥ ìˆëŠ” ê°œë°œì ë©˜í† ì…ë‹ˆë‹¤.
                
                [í˜„ì¬ í•™ìƒ ì½”ë“œ]:
                ${studentCode}

                [í•™ìƒ ì§ˆë¬¸]: 
                ${userText}
                
                <ë‹µë³€ ê°€ì´ë“œë¼ì¸>
                1. ë§íˆ¬: "í•´ìš”/í•©ë‹ˆë‹¤"ì²´ë¥¼ ì‚¬ìš©í•˜ë˜, ìœ ì¹˜í•œ ê°íƒ„ì‚¬ë‚˜ ì´ëª¨í‹°ì½˜ì€ ì ˆì œí•˜ê³  ë‹´ë°±í•˜ê³  ì „ë¬¸ì ìœ¼ë¡œ ë‹µë³€í•˜ì„¸ìš”.
                2. ë‚´ìš©: ì •ë‹µë§Œ ì•Œë ¤ì£¼ê¸°ë³´ë‹¤ 'ì›ë¦¬'ì™€ 'ë…¼ë¦¬'ë¥¼ ì„¤ëª…í•´ì£¼ì„¸ìš”. í•„ìš”í•œ ê²½ìš° ì»´í“¨í„° ê³µí•™ ìš©ì–´ë¥¼ ì ì ˆíˆ ì„ì–´ì„œ ì„¤ëª…í•´ë„ ì¢‹ìŠµë‹ˆë‹¤.
                3. ëª©í‘œ: í•™ìƒì´ ìŠ¤ìŠ¤ë¡œ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆë„ë¡ í•µì‹¬ì ì¸ íŒíŠ¸ë‚˜ ë””ë²„ê¹… ë°©ë²•ì„ ì œì‹œí•˜ì„¸ìš”.
            `;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${GOOGLE_API_KEY}`;

            try {
                const loadingId = "loading-" + Date.now();
                chatArea.innerHTML += `<div id="${loadingId}" class="msg-ai"><span>ğŸ¤– ìƒê°í•˜ëŠ” ì¤‘...</span></div>`;
                chatArea.scrollTop = chatArea.scrollHeight;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                document.getElementById(loadingId).remove();

                if (data.candidates && data.candidates[0].content) {
                    const aiText = data.candidates[0].content.parts[0].text;
                    const formattedText = aiText.replace(/\n/g, '<br>');
                    
                    chatArea.innerHTML += `<div class="msg-ai"><span>${formattedText}</span></div>`;
                    
                    // íŒŒì´ì–´ë² ì´ìŠ¤ ì €ì¥
                    if (sid && sname) { 
                        db.collection("chat_logs").add({
                            schoolId: sid, name: sname, question: userText, answer: aiText, timestamp: new Date()
                        });
                    }
                } else if (data.error) {
                    chatArea.innerHTML += `<div class="error-msg">âš ï¸ ì˜¤ë¥˜: ${data.error.message}</div>`;
                }
                
                // ë‹µë³€ ì˜¨ í›„ ìŠ¤í¬ë¡¤ ë‚´ë¦¬ê¸°
                chatArea.scrollTop = chatArea.scrollHeight;

            } catch (error) {
                if(document.getElementById(loadingId)) document.getElementById(loadingId).remove();
                chatArea.innerHTML += `<div class="error-msg">âš ï¸ í†µì‹  ì‹¤íŒ¨: ${error.message}</div>`;
            }
        }

        document.getElementById("user-input").addEventListener("keypress", function(e) {
            if (e.key === "Enter") sendMessage();
        });
    </script>
</body>

</html>
